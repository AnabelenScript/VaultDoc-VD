<div class="persons-container">

  <div class="convert-header">
    <div class="search-section">
      <div class="search-bar">
        <i class="search-icon"><i class='bx bx-search-alt-2'></i></i>
        <input 
          type="text" 
          placeholder="Buscar" 
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
          class="search-input">
        <button class="filter-button" type="button"></button>
      </div>
    </div>

    <div class="actions-section">
      <div class="archive-count">
        <span class="archive-label">Personas:</span>
        <span class="archive-number">{{ archiveCount }}</span>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="action-buttons">
    <button routerLink="/historial">Historial de acciones</button>
    <button (click)="toggleAddModal()">
      {{ currentUser?.roleId === 2 ? 'Agregar trabajador' : 'Agregar jefe de departamento' }}
    </button>
  </div>

<div class="content-section" *ngFor="let department of departments">
  <!-- Mostrar solo si es admin o si es el departamento del jefe -->
  <ng-container *ngIf="currentUser?.roleId === 3 || currentUser?.department === department">
    <div class="section-header" (click)="toggleDepartmentVisibility(department)">
      <i class="toggle-icon" [class.rotated]="!departmentVisibility[department]">▼</i>
      <h3>{{ department }}</h3>
    </div>

    <div class="files-table-container" *ngIf="departmentVisibility[department]">
      <!-- Si hay usuarios en el departamento -->
      <div *ngIf="hasUsersInDepartment(department)">
        <div class="userinfo" *ngFor="let user of getUsersForDepartment(department)">
          <h4>{{ (user.nombre && user.apellidos) ? (user.nombre + ' ' + user.apellidos) : user.email }}</h4>
          <div class="user-actions">
            <button class="delete-btn" (click)="openDeleteModal(user)" title="Eliminar usuario">
              <i class='bx bx-trash'></i>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="!hasUsersInDepartment(department)" class="no-users-message">
        <p>No hay usuarios para este departamento</p>
      </div>
    </div>
  </ng-container>
</div>
  <!-- Modal para agregar usuario -->
  <div class="AddModal" *ngIf="showAddModal">
    <div class="modalbackground" (click)="toggleAddModal()"></div>
    <div class="Addcontainer">
      <h4>{{ currentUser?.roleId === 2 ? 'Agregar trabajador' : 'Agregar jefe' }}</h4>

      <div class="inputform">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" [(ngModel)]="newUser.nombre" placeholder="Nombre">
      </div>

      <div class="inputform">
        <label for="apellidos">Apellidos</label>
        <input type="text" id="apellidos" [(ngModel)]="newUser.apellidos" placeholder="Apellidos">
      </div>

      <div class="inputform">
        <label for="department">Departamento</label>
        <ng-container *ngIf="currentUser?.roleId === 2; else deptSelect">
          <input type="text" id="department" [(ngModel)]="newUser.department" [value]="currentUser?.department" disabled>
        </ng-container>
        <ng-template #deptSelect>
          <select id="department" [(ngModel)]="newUser.department" class="department-select">
            <option value="">Seleccionar departamento</option>
            <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
          </select>
        </ng-template>
      </div>

      <div class="datosPersonales">
        <div class="inputform">
          <label for="email">Correo electrónico</label>
          <input type="email" id="email" [(ngModel)]="newUser.email" placeholder="correo@ejemplo.com">
        </div>
        <div class="inputform">
          <label for="password">Password</label>
          <input type="password" id="password" [(ngModel)]="newUser.password" placeholder="Contraseña">
        </div>
      </div>

      <div class="Optionsbuttons">
        <button class="cancelButton" (click)="toggleAddModal()">Cancelar</button>
        <button class="Addbutton" (click)="addUser()" [disabled]="!validateForm()">Guardar datos</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para eliminar -->
  <div class="DeleteModal" *ngIf="showDeleteModal">
    <div class="modalbackground" (click)="closeDeleteModal()"></div>
    <div class="DeleteContainer">
      <h4>Confirmar eliminación</h4>
      <p>¿Está seguro de que desea eliminar al usuario <strong>{{ userToDelete?.nombre }} {{ userToDelete?.apellidos }}</strong>?</p>
      <p class="warning-text">Esta acción no se puede deshacer.</p>

      <div class="Optionsbuttons">
        <button class="cancelButton" (click)="closeDeleteModal()">Cancelar</button>
        <button class="deleteButton" (click)="confirmDeleteUser()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
